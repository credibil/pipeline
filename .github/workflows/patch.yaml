# Creates a patch version on a release branch. 
# The workflow bumps the patch version and updates the release notes for the
# selected branch.

name: Create Patch

on:
  workflow_call:

permissions:
  contents: write

jobs:
  skip:
    name: Skipped
    if: ${{ !startsWith(github.ref_name, 'release-') }}
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo "This workflow only runs on the 'release-*' branches"
          exit 1
          
  # Increment patch version and update RELEASES.md
  # Push back to the release-<version> branch for review and publishing
  patch:
    name: Bump patch version
    if: startsWith(github.ref_name, 'release-')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        
      - name: Set git identity
        uses: credibil/pipeline/.github/actions/git-identity@main

      - name: Current version
        id: current
        uses: credibil/pipeline/.github/actions/cargo-version@main

      - name: Install cargo-release
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-release

      - name: Bump version
        run: cargo release version patch --execute --no-confirm

      - name: Check semver
        uses: obi1kenobi/cargo-semver-checks-action@v2
        with:
          baseline-rev: ${{ github.ref_name }}
          release-type: patch

      - name: Patch version
        id: patch
        uses: credibil/pipeline/.github/actions/cargo-version@main

      - name: Update release notes
        uses: credibil/pipeline/.github/actions/release-notes@main
        with:
          version: ${{ steps.patch.outputs.version }}
          branch: ${{ github.ref_name }}
